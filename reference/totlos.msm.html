<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Total length of stay, or expected number of visits — totlos.msm • msm</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Total length of stay, or expected number of visits — totlos.msm"><meta name="description" content="Estimate the expected total length of stay, or the expected number of
visits, in each state, for an individual in a given period of evolution of a
multi-state model."><meta property="og:description" content="Estimate the expected total length of stay, or the expected number of
visits, in each state, for an individual in a given period of evolution of a
multi-state model."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">msm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.8.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/chjackson/msm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Total length of stay, or expected number of visits</h1>
      <small class="dont-index">Source: <a href="https://github.com/chjackson/msm/blob/master/R/totlos.R" class="external-link"><code>R/totlos.R</code></a></small>
      <div class="d-none name"><code>totlos.msm.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Estimate the expected total length of stay, or the expected number of
visits, in each state, for an individual in a given period of evolution of a
multi-state model.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">totlos.msm</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  start <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  end <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fromt <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  tot <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  covariates <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  piecewise.times <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  piecewise.covariates <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  num.integ <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  discount <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  env <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  ci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="st">"normal"</span>, <span class="st">"bootstrap"</span><span class="op">)</span>,</span>
<span>  cl <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  B <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  cores <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">envisits.msm</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  start <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  end <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fromt <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  tot <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  covariates <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  piecewise.times <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  piecewise.covariates <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  num.integ <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  discount <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  ci <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="st">"normal"</span>, <span class="st">"bootstrap"</span><span class="op">)</span>,</span>
<span>  cl <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  B <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  cores <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>A fitted multi-state model, as returned by <code><a href="msm.html">msm</a></code>.</p></dd>


<dt id="arg-start">start<a class="anchor" aria-label="anchor" href="#arg-start"></a></dt>
<dd><p>Either a single number giving the state at the beginning of the
period, or a vector of probabilities of being in each state at this time.</p></dd>


<dt id="arg-end">end<a class="anchor" aria-label="anchor" href="#arg-end"></a></dt>
<dd><p>States to estimate the total length of stay (or number of visits)
in. Defaults to all states.  This is deprecated, since with the analytic
solution (see "Details") it doesn't save any computation to only estimate
for a subset of states.</p></dd>


<dt id="arg-fromt">fromt<a class="anchor" aria-label="anchor" href="#arg-fromt"></a></dt>
<dd><p>Time from which to estimate.  Defaults to 0, the beginning of
the process.</p></dd>


<dt id="arg-tot">tot<a class="anchor" aria-label="anchor" href="#arg-tot"></a></dt>
<dd><p>Time up to which the estimate is made.  Defaults to infinity,
giving the expected time spent in or number of visits to the state until
absorption. However, the calculation will be much more efficient if a finite
(potentially large) time is specified: see the "Details" section.  For
models without an absorbing state, <code>t</code> must be specified.</p></dd>


<dt id="arg-covariates">covariates<a class="anchor" aria-label="anchor" href="#arg-covariates"></a></dt>
<dd><p>The covariate values to estimate for.  This can either
be:<br></p>
<p>the string <code>"mean"</code>, denoting the means of the covariates in the data
(this is the default),<br></p>
<p>the number <code>0</code>, indicating that all the covariates should be set to
zero,<br></p>
<p>or a list of values, with optional names. For example</p>
<p><code>list (60, 1)</code></p>
<p>where the order of the list follows the order of the covariates originally
given in the model formula, or a named list,</p>
<p><code>list (age = 60, sex = 1)</code></p></dd>


<dt id="arg-piecewise-times">piecewise.times<a class="anchor" aria-label="anchor" href="#arg-piecewise-times"></a></dt>
<dd><p>Times at which piecewise-constant intensities change.
See <code><a href="pmatrix.piecewise.msm.html">pmatrix.piecewise.msm</a></code> for how to specify this. This is
only required for time-inhomogeneous models specified using explicit
time-dependent covariates, and should not be used for models specified using
"pci".</p></dd>


<dt id="arg-piecewise-covariates">piecewise.covariates<a class="anchor" aria-label="anchor" href="#arg-piecewise-covariates"></a></dt>
<dd><p>Covariates on which the piecewise-constant
intensities depend. See <code><a href="pmatrix.piecewise.msm.html">pmatrix.piecewise.msm</a></code> for how to
specify this.</p></dd>


<dt id="arg-num-integ">num.integ<a class="anchor" aria-label="anchor" href="#arg-num-integ"></a></dt>
<dd><p>Use numerical integration instead of analytic solution (see
below).</p></dd>


<dt id="arg-discount">discount<a class="anchor" aria-label="anchor" href="#arg-discount"></a></dt>
<dd><p>Discount rate in continuous time.</p></dd>


<dt id="arg-env">env<a class="anchor" aria-label="anchor" href="#arg-env"></a></dt>
<dd><p>Supplied to <code>totlos.msm</code>.  If <code>TRUE</code>, return the
expected number of visits to each state. If <code>FALSE</code>, return the total
length of stay in each state. <code>envisits.msm</code> simply calls
<code>totlos.msm</code> with <code>env=TRUE</code>.</p></dd>


<dt id="arg-ci">ci<a class="anchor" aria-label="anchor" href="#arg-ci"></a></dt>
<dd><p>If <code>"normal"</code>, then calculate a confidence interval by
simulating <code>B</code> random vectors from the asymptotic multivariate normal
distribution implied by the maximum likelihood estimates (and covariance
matrix) of the log transition intensities and covariate effects, then
calculating the total length of stay for each replicate.</p>
<p>If <code>"bootstrap"</code> then calculate a confidence interval by non-parametric
bootstrap refitting.  This is 1-2 orders of magnitude slower than the
<code>"normal"</code> method, but is expected to be more accurate. See
<code><a href="boot.msm.html">boot.msm</a></code> for more details of bootstrapping in <span class="pkg">msm</span>.</p>
<p>If <code>"none"</code> (the default) then no confidence interval is calculated.</p></dd>


<dt id="arg-cl">cl<a class="anchor" aria-label="anchor" href="#arg-cl"></a></dt>
<dd><p>Width of the symmetric confidence interval, relative to 1</p></dd>


<dt id="arg-b">B<a class="anchor" aria-label="anchor" href="#arg-b"></a></dt>
<dd><p>Number of bootstrap replicates</p></dd>


<dt id="arg-cores">cores<a class="anchor" aria-label="anchor" href="#arg-cores"></a></dt>
<dd><p>Number of cores to use for bootstrapping using parallel
processing. See <code><a href="boot.msm.html">boot.msm</a></code> for more details.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Further arguments to be passed to the <code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></code>
function to control the numerical integration.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A vector of expected total lengths of stay
(<code>totlos.msm</code>), or expected number of visits
(<code>envisits.msm</code>), for each transient state.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The expected total length of stay in state \(j\) between times \(t_1\)
and \(t_2\), from the point of view of an individual in state \(i\) at
time 0, is defined by the integral from \(t_1\) to \(t_2\) of the
\(i,j\) entry of the transition probability matrix \(P(t) = Exp(tQ)\),
where \(Q\) is the transition intensity matrix.</p>
<p>The corresponding expected number of visits to state \(j\) (excluding the
stay in the current state at time 0) is \(\sum_{i!=j} T_i Q_{i,j}\), where
\(T_i\) is the expected amount of time spent in state \(i\).</p>
<p>More generally, suppose that \(\pi_0\) is the vector of
probabilities of being in each state at time 0, supplied in <code>start</code>,
and we want the vector \(\mathbf{x}\) giving the expected lengths of
stay in each state.  The corresponding integral has the following solution
(van Loan 1978; van Rosmalen et al. 2013)</p>
<p>$$\mathbf{x} =
\left[
\begin{array}{ll}
1  &amp;  \mathbf{0}_K
\end{array}
\right]
Exp(t Q')
\left[
\begin{array}{l} \mathbf{0}_K\\I_K
\end{array}
\right]
$$</p>
<p>where $$Q' = \left[
\begin{array}{ll} 0 &amp; \mathbf{\pi}_0\\
\mathbf{0}_K  &amp;  Q - rI_K
\end{array}
\right]
$$</p>
<p>\(\pi_0\) is the row vector of initial state probabilities supplied
in <code>start</code>, \(\mathbf{0}_K\) is the row vector of K zeros,
\(r\) is the discount rate, \(I_K\) is the K x K identity matrix,
and \(Exp\) is the matrix exponential.</p>
<p>Alternatively, the integrals can be calculated numerically, using the
<code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></code> function.  This may take a long time for models with
many states where \(P(t)\) is expensive to calculate.  This is required
where <code>tot = Inf</code>, since the package author is not aware of any
analytic expression for the limit of the above formula as \(t\) goes to
infinity.</p>
<p>With the argument <code>num.integ=TRUE</code>, numerical integration is used even
where the analytic solution is available. This facility is just provided for
checking results against versions 1.2.4 and earlier, and will be removed
eventually. Please let the package maintainer know if any results are
different.</p>
<p>For a model where the individual has only one place to go from each state,
and each state is visited only once, for example a progressive disease model
with no recovery or death, these are equal to the mean sojourn time in each
state.  However, consider a three-state health-disease-death model with
transitions from health to disease, health to death, and disease to death,
where everybody starts healthy.  In this case the mean sojourn time in the
disease state will be greater than the expected length of stay in the
disease state.  This is because the mean sojourn time in a state is
conditional on entering the state, whereas the expected total time diseased
is a forecast for a healthy individual, who may die before getting the
disease.</p>
<p>In the above formulae, \(Q\) is assumed to be constant over time, but the
results generalise easily to piecewise-constant intensities.  This function
automatically handles models fitted using the <code>pci</code> option to
<code><a href="msm.html">msm</a></code>. For any other inhomogeneous models, the user must specify
<code>piecewise.times</code> and <code>piecewise.covariates</code> arguments to
<code>totlos.msm</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>C. van Loan (1978). Computing integrals involving the matrix
exponential. IEEE Transactions on Automatic Control 23(3)395-404.</p>
<p>J. van Rosmalen, M. Toy and J.F. O'Mahony (2013). A mathematical approach
for evaluating Markov models in continuous time without discrete-event
simulation.  Medical Decision Making 33:767-779.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="sojourn.msm.html">sojourn.msm</a></code>, <code><a href="pmatrix.msm.html">pmatrix.msm</a></code>,
<code><a href="https://rdrr.io/r/stats/integrate.html" class="external-link">integrate</a></code>, <code><a href="boot.msm.html">boot.msm</a></code>.</p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>C. H. Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk">chris.jackson@mrc-bsu.cam.ac.uk</a></p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

